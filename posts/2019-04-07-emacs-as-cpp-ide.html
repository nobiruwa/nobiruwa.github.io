<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/hakyll-cssgarden/bronx.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">
    <title>My Hakyll Blog - EmacsでのC/C++開発</title>
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">Nobiruwa's</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
      </div>
    </div>

    <div id="content">
      <h1>EmacsでのC/C++開発</h1>

      <div class="info">
    Posted on April  7, 2019
    
        by nobiruwa
    
</div>

<h2 id="tldr">tl;dr</h2>
<p>lsp-modeとcclsを用いることで、十分に快適な環境を得ることができました。</p>
<h2 id="切っ掛け">切っ掛け</h2>
<p><a href="http://www.opengl-tutorial.org/">OpenGLのチュートリアル</a>を使って学習しているところ、GNU Globalでは一部のAPIの補完がイマイチだったので、環境を模索することにしました。</p>
<p>例えば、以下のAPIはGNU Globalが<code>/usr/include</code>配下を入力して作るタグGTAGSには登録されません。</p>
<div class="sourceCode" id="mycode" data-startFrom="100"><pre class="sourceCode numberSource cpp numberLines"><code class="sourceCode cpp" style="counter-reset: source-line 99;"><span id="mycode-100"><a href="#mycode-100"></a><span class="pp">#define glBindVertexArray </span>GLEW_GET_FUN<span class="op">(</span>__glewBindVertexArray<span class="op">)</span></span></code></pre></div>
<p>目標はOpenGLの開発をベンチマークとして、以下の事が実現できるようになることです。</p>
<ol type="1">
<li>関数名の補完ができる</li>
<li>関数の引数の型・戻り値(つまり関数の型)が分かる</li>
<li>貧弱なPCでもストレスなく使用できる</li>
</ol>
<h2 id="変遷">変遷</h2>
<ol type="1">
<li><a href="https://github.com/leoliu/ggtags">ggtags</a> + <a href="https://www.gnu.org/software/global/">GNU Global</a>
<ul>
<li>glewのAPIが補完できたりできなかったりしました。</li>
<li>関数を参照するヘッダー内行を検索することで関数の型が分かるのですが、カレントバッファーがいちいちヘッダーファイルに変化するのが億劫に感じました。</li>
</ul></li>
<li>ggtags + <a href="http://ctags.sourceforge.net/">Exuberant Ctags</a>
<ul>
<li>GNU Globalと大差ありませんでした。</li>
</ul></li>
<li><a href="https://github.com/Sarcasm/irony-mode">irony-mode</a>
<ul>
<li><code>glBindVertexArray</code>を補完できるようになりましたが、関数の型が分からず惜しいです。</li>
</ul></li>
<li><a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a> + <a href="https://clang.llvm.org/extra/clangd/">clangd</a>
<ul>
<li>補完と関数の型は申し分ありませんでした。</li>
<li>ただ、clangdがlsp-modeから送信されるリクエストを処理しきれず、CPU使用率が100%を超えしばしば通信が切断されます。</li>
</ul></li>
<li><a href="https://github.com/joaotavora/eglot">eglot</a> + clangd
<ul>
<li>補完と関数の型はlsp-modeほどの情報量はありませんでしたが、申し分ありませんでした。</li>
<li>eglotはEmacs側でリクエストをdebounceしますが、clangdはそれでも負荷が高いです。</li>
</ul></li>
<li><a href="https://github.com/abingham/emacs-ycmd">emacs-ycmd</a> + <a href="https://github.com/Valloric/ycmd">ycmd</a>
<ul>
<li>期待したような情報が表示されず、カスタマイズによる改善を断念しました。</li>
</ul></li>
<li>ggtags + <a href="https://github.com/universal-ctags/ctags">universal-ctags</a>
<ul>
<li>universal-ctagsのコマンドを読み解くのが面倒になり使用を断念しました。</li>
</ul></li>
<li>lsp-mode + <a href="https://github.com/MaskRay/ccls">ccls</a>
<ul>
<li>補完と関数の型は申し分ありませんでした。</li>
<li>cclsがdeounce(キューに溜まったリクエストを間引く)するようで、CPU使用率は許容範囲でした。</li>
</ul></li>
</ol>
<h2 id="lsp-mode-ccls-の構築手順">lsp-mode + ccls の構築手順</h2>
<p>開発のモードとしてlsp-modeを用い、バックエンドにはCCLSを用います。</p>
<p>この組み合わせが気に入った理由は以下の通りです。</p>
<ol type="1">
<li>lsp-mode + <a href="https://github.com/tigersoldier/company-lsp">company-lsp</a> + <a href="https://github.com/emacs-lsp/lsp-ui">lsp-ui</a> により、様々な情報が出力されます。</li>
<li>cclsは他のバックエンド(clangd、<a href="https://github.com/cquery-project/cquery">cquery</a>)に比べて動作が軽量です。
<ul>
<li><a href="https://langserver.org/">LSP</a> (<a href="https://microsoft.github.io/language-server-protocol/">Language Protocol Server</a>) に基づいているため、フロントエンドとバックエンドは乗り換えが比較的容易です。</li>
</ul></li>
</ol>
<p>cclsはクライアントからのリクエストを適度にdebounce(間引く)するため、比較的CPU使用率が跳ね上がることを防いでいるようです。</p>
<p>詳細はさておき、Clang 7 (2019年4月現在、Debian SidのデフォルトのClangがこのバージョンのため)と組み合わせて開発環境を揃えるための手順と設定を記録しておきます。</p>
<h4 id="clangのインストール-cclsのビルド">Clangのインストール + cclsのビルド</h4>
<pre class="console"><code>$ sudo apt-get install cmake libclang-7-dev clang-format-7 clang-tools-7
$ cd ~/repo
$ git clone --depth=1 --recursive https://github.com/MaskRay/ccls.git ccls.git
$ cd ccls.git
$ sed -i -e 's/find_program(CLANG_EXECUTABLE clang)/find_program(CLANG_EXECUTABLE clang-7)/' CMakeLists.txt
$ cmake -H. -BRelease -DCMAKE_BUILD_TYPE=Release 
$ cmake --build Release</code></pre>
<h4 id="emacsパッケージのインストール">Emacsパッケージのインストール</h4>
<pre class="emacs"><code>M-x package-install
ccls
clang-format
lsp-mode
lsp-ui</code></pre>
<h4 id="emacsパッケージの設定">Emacsパッケージの設定</h4>
<div class="sourceCode" id="cb3"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; ccls</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'ccls)</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> ccls-executable (expand-file-name <span class="st">&quot;~/repo/ccls.git/Release/ccls&quot;</span>))</span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; clang-format</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'clang-format)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> clang-format-executable <span class="st">&quot;/usr/bin/clang-format-7&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb5"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; company-mode</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">;; company-*</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="co">;;;</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'company)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; company-backends</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'company-clang)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> company-clang-executable (executable-find <span class="st">&quot;/usr/bin/clang-7&quot;</span>))</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> company-clang--version '(normal . <span class="fl">7.0</span>))</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'company-dict)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'company-lsp)</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> company-dict-dir <span class="st">&quot;~/repo/nobiruwa.github/dot-emacs.d.git/company-dict&quot;</span>)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>(with-eval-after-load <span class="st">&quot;company&quot;</span></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>  (global-company-mode +<span class="dv">1</span>)</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; C-[ C-i</span></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a>  (global-set-key (kbd <span class="st">&quot;C-M-i&quot;</span>) 'company-complete)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a>  (define-key emacs-lisp-mode-map (kbd <span class="st">&quot;C-M-i&quot;</span>) 'company-complete)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>  (define-key lisp-interaction-mode-map (kbd <span class="st">&quot;C-M-i&quot;</span>) 'company-complete)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">setq</span> company-backends</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>        '(company-bbdb</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a>          company-nxml</span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a>          company-css</span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>          company-eclim</span>
<span id="cb5-29"><a href="#cb5-29" aria-hidden="true" tabindex="-1"></a>          company-semantic</span>
<span id="cb5-30"><a href="#cb5-30" aria-hidden="true" tabindex="-1"></a>          company-lsp</span>
<span id="cb5-31"><a href="#cb5-31" aria-hidden="true" tabindex="-1"></a>          company-clang</span>
<span id="cb5-32"><a href="#cb5-32" aria-hidden="true" tabindex="-1"></a>          company-xcode</span>
<span id="cb5-33"><a href="#cb5-33" aria-hidden="true" tabindex="-1"></a>          company-cmake</span>
<span id="cb5-34"><a href="#cb5-34" aria-hidden="true" tabindex="-1"></a>          company-capf</span>
<span id="cb5-35"><a href="#cb5-35" aria-hidden="true" tabindex="-1"></a>          company-files</span>
<span id="cb5-36"><a href="#cb5-36" aria-hidden="true" tabindex="-1"></a>          (company-dabbrev-code company-etags company-keywords company-dict)</span>
<span id="cb5-37"><a href="#cb5-37" aria-hidden="true" tabindex="-1"></a>          company-oddmuse</span>
<span id="cb5-38"><a href="#cb5-38" aria-hidden="true" tabindex="-1"></a>          company-dabbrev)))</span></code></pre></div>
<div class="sourceCode" id="cb6"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; lsp-mode</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'lsp-mode)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> lsp-clients-clangd-executable <span class="st">&quot;/usr/bin/clangd-7&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> lsp-prefer-flymake <span class="kw">nil</span>)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; # apt-get install clang-tools-7 # libclang-devのメジャーバージョンと合わせる</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co">;; C++ではclang-formatが必要</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>(add-hook 'c-mode-hook #'lsp)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>(add-hook 'c++-mode-hook #'lsp)</span></code></pre></div>
<div class="sourceCode" id="cb7"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; lsp-ui</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'lsp-ui)</span></code></pre></div>

    </div>
    <div id="footer">
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </div>
  </body>
</html>
