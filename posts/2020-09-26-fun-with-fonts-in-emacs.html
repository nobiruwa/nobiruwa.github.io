<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/hakyll-cssgarden/bronx.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">
    <title>My Hakyll Blog - Emacs 26.3 でのフォント設定</title>
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">Nobiruwa's</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
      </div>
    </div>

    <div id="content">
      <h1>Emacs 26.3 でのフォント設定</h1>

      <div class="info">
    Posted on September 26, 2020
    
        by nobiruwa
    
</div>

<h2 id="tldr">tl;dr</h2>
<p>以下の設定となりました。</p>
<ul>
<li>日本語とASCII文字には<a href="http://vlgothic.dicey.org/">VL Gothic</a>を使います。</li>
<li>それ以外には<a href="https://fonts.google.com/specimen/Noto+Sans">Noto Sans</a>を使います。</li>
<li>ベンガル語の文字(<a href="https://en.wikipedia.org/wiki/Bengali_alphabet">Bengali alphabet (Wikipedia)</a>)には<a href="https://en.wikipedia.org/wiki/GNU_FreeFont">Free Sans</a>を使います。
<ul>
<li>Noto Sansだと<a href="https://www.nongnu.org/m17n/">libm17nのlibotf</a>がクラッシュするため、その回避のためです。</li>
</ul></li>
</ul>
<div class="sourceCode" id="cb1"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;</span></span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; customize font</span></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a><span class="co">;; Ref: https://www.shimmy1996.com/en/posts/2018-06-24-fun-with-fonts-in-emacs/</span></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> user--cjk-font </span><span class="st">&quot;VL Gothic&quot;</span></span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Default font for CJK characters&quot;</span>)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> user--latin-font </span><span class="st">&quot;VL Gothic&quot;</span></span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Default font for Latin characters&quot;</span>)</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> user--unicode-font </span><span class="st">&quot;Noto Sans&quot;</span></span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Default font for Unicode characters. including emojis&quot;</span>)</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a><span class="co">;; Notoフォントでベンガル語(charset名はbengali)を表示するとクラッシュする。</span></span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a><span class="co">;; バックトレースを見るとlibm17n/libotf0でクラッシュしているようだ。</span></span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a><span class="co">;; $ fc-list :lang=bn</span></span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a><span class="co">;; を実行してベンガル語をサポートするフォント一覧を出力すると、</span></span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a><span class="co">;; Notoフォント以外にFreeSansがある。</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a><span class="co">;; ので、FreeSansをフォールバックフォントとして用いる。</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> user--unicode-font-fallback </span><span class="st">&quot;FreeSans&quot;</span></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Fallback font for Unicode characters.&quot;</span>)</span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defvar</span><span class="fu"> user--standard-fontset</span></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  (create-fontset-from-fontset-spec standard-fontset-spec)</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Standard fontset for user.&quot;</span>)</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> user--set-font </span>()</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Set Unicode, Latin and CJK font for user--standard-fontset.&quot;</span></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  (set-fontset-font user--standard-fontset 'unicode</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a>                    (font-spec :family user--unicode-font)</span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">nil</span> 'prepend)</span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a>  (set-fontset-font user--standard-fontset 'latin</span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>                    (font-spec :family user--latin-font)</span>
<span id="cb1-34"><a href="#cb1-34" aria-hidden="true" tabindex="-1"></a>                    <span class="kw">nil</span> 'prepend)</span>
<span id="cb1-35"><a href="#cb1-35" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dolist</span> (charset '(kana han cjk-misc hangul kanbun bopomofo))</span>
<span id="cb1-36"><a href="#cb1-36" aria-hidden="true" tabindex="-1"></a>    (set-fontset-font user--standard-fontset charset</span>
<span id="cb1-37"><a href="#cb1-37" aria-hidden="true" tabindex="-1"></a>                  (font-spec :family user--cjk-font)</span>
<span id="cb1-38"><a href="#cb1-38" aria-hidden="true" tabindex="-1"></a>                  <span class="kw">nil</span> 'prepend))</span>
<span id="cb1-39"><a href="#cb1-39" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dolist</span> (charset '((<span class="ch">#x</span>2018 . #x2019)    ;; Curly single quotes &quot;‘’&quot;</span>
<span id="cb1-40"><a href="#cb1-40" aria-hidden="true" tabindex="-1"></a>                     (<span class="ch">#x</span>201c . #x201d)))  ;; Curly double quotes &quot;“”&quot;</span>
<span id="cb1-41"><a href="#cb1-41" aria-hidden="true" tabindex="-1"></a>    (set-fontset-font user--standard-fontset charset</span>
<span id="cb1-42"><a href="#cb1-42" aria-hidden="true" tabindex="-1"></a>                      (font-spec :family user--cjk-font)</span>
<span id="cb1-43"><a href="#cb1-43" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">nil</span> 'prepend))</span>
<span id="cb1-44"><a href="#cb1-44" aria-hidden="true" tabindex="-1"></a>  <span class="co">;; フォールバックフォントを用いる言語(charsetは C-u C-x = のscriptセクションの名前を用いる)</span></span>
<span id="cb1-45"><a href="#cb1-45" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">dolist</span> (charset '(bengali bengali-akruti bengali-cdac))</span>
<span id="cb1-46"><a href="#cb1-46" aria-hidden="true" tabindex="-1"></a>    (set-fontset-font user--standard-fontset charset</span>
<span id="cb1-47"><a href="#cb1-47" aria-hidden="true" tabindex="-1"></a>                      (font-spec :family user--unicode-font-fallback)</span>
<span id="cb1-48"><a href="#cb1-48" aria-hidden="true" tabindex="-1"></a>                      <span class="kw">nil</span> 'prepend)))</span>
<span id="cb1-49"><a href="#cb1-49" aria-hidden="true" tabindex="-1"></a>(user--set-font)</span>
<span id="cb1-50"><a href="#cb1-50" aria-hidden="true" tabindex="-1"></a>(add-hook 'before-make-frame-hook #'user--set-font)</span>
<span id="cb1-51"><a href="#cb1-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-52"><a href="#cb1-52" aria-hidden="true" tabindex="-1"></a><span class="co">;; Ensure user--standard-fontset gets used for new frames.</span></span>
<span id="cb1-53"><a href="#cb1-53" aria-hidden="true" tabindex="-1"></a>(add-to-list 'default-frame-alist (<span class="kw">cons</span> 'font user--standard-fontset))</span>
<span id="cb1-54"><a href="#cb1-54" aria-hidden="true" tabindex="-1"></a>(add-to-list 'initial-frame-alist (<span class="kw">cons</span> 'font user--standard-fontset))</span></code></pre></div>
<h2 id="problemsの抜粋">PROBLEMSの抜粋</h2>
<p>libotfに関する問題の存在は<code>PROBLEMS</code>ファイルにしっかりと書かれていました。 Emacsのよいところは公式がドキュメント化をしっかりしているところで、<code>PROBLEMS</code>ファイルにしっかり目を通しましょう、という教訓になりました。</p>
<pre class="org"><code>** Emacs crashes when you try to view a file with complex characters.

One possible reason for this could be a bug in the libotf or the
libm17n-flt/m17n-db libraries Emacs uses for displaying complex
scripts.  Make sure you have the latest versions of these libraries
installed.  If the problem still persists with the latest released
versions of these libraries, you can try building these libraries from
their CVS repository:

  cvs -z3 -d:pserver:anonymous@cvs.savannah.nongnu.org:/sources/m17n co libotf
  cvs -z3 -d:pserver:anonymous@cvs.savannah.nongnu.org:/sources/m17n co m17n-db
  cvs -z3 -d:pserver:anonymous@cvs.savannah.nongnu.org:/sources/m17n co m17n-lib

One known problem that causes such crashes is with using Noto Serif
Kannada fonts.  To work around that, force Emacs not to select these
fonts, by adding the following to your ~/.emacs init file:

  (push &quot;Noto Serif Kannada&quot; face-ignored-fonts)

You can try this interactively in a running Emacs session like this:

  M-: (push &quot;Noto Serif Kannada&quot; face-ignored-fonts) RET

Another set of problems is caused by an incompatible libotf library.
In this case, displaying the etc/HELLO file (as shown by C-h h)
triggers the following message to be shown in the terminal from which
you launched Emacs:

  symbol lookup error: /usr/bin/emacs: undefined symbol: OTF_open

This problem occurs because unfortunately there are two libraries
called &quot;libotf&quot;.  One is the library for handling OpenType fonts,
http://www.m17n.org/libotf/, which is the one that Emacs expects.
The other is a library for Open Trace Format, and is used by some
versions of the MPI message passing interface for parallel
programming.

For example, on RHEL6 GNU/Linux, the OpenMPI rpm provides a version
of &quot;libotf.so&quot; in /usr/lib/openmpi/lib.  This directory is not
normally in the ld search path, but if you want to use OpenMPI,
you must issue the command &quot;module load openmpi&quot;.  This adds
/usr/lib/openmpi/lib to LD_LIBRARY_PATH.  If you then start Emacs from
the same shell, you will encounter this crash.
Ref: &lt;URL:https://bugzilla.redhat.com/show_bug.cgi?id=844776&gt;

There is no good solution to this problem if you need to use both
OpenMPI and Emacs with libotf support.  The best you can do is use a
wrapper shell script (or function) &quot;emacs&quot; that removes the offending
element from LD_LIBRARY_PATH before starting emacs proper.
Or you could recompile Emacs with an -Wl,-rpath option that
gives the location of the correct libotf.</code></pre>
<h2 id="切っ掛け">切っ掛け</h2>
<p>tarから<code>~/opt/firefox</code>に展開して使っているFirefoxをユーザーのデフォルトのWebブラウザに設定しようと、 Firefoxのdesktopファイルを作ることにしました。一方でchromiumをパッケージとしてインストールしてあり、 <code>/usr/share/applications/chromium.desktop</code>を参考に<code>~/.local/share/applications/firefox.desktop</code>を 作ることにしました。しかし、Emacsで<code>/usr/share/applications/chromium.desktop</code>を開こうとするとクラッシュします。 Emacsで開けないテキストファイルがあるのは非常に困るので、問題を調査することにしました。</p>
<h2 id="解決までにやったこと">解決までにやったこと</h2>
<ol type="1">
<li>別のエディタ、<code>vi</code>や<code>gedit</code>で開いてみる
<ul>
<li>クラッシュしない</li>
<li><code>chromium.desktop</code>を見ると様々な言語でコメントが書かれており、文字表示のバグだと推測する</li>
</ul></li>
<li><code>~/.xsession-errors</code>を見る
<ul>
<li>Emacsのバックトレースがあり、<code>libotf.so.0</code>と<code>libm17n-flt.so.0</code>が原因だと推測する</li>
</ul></li>
<li><code>chromium.desktop</code>を1行ずつファイルに分けて出力し、問題が起きる行を特定する
<ul>
<li><code>GenericName[bn]=ওয়েব ব্রাউজার</code>で落ちる</li>
<li>アルファベット2文字コード<code>bn</code>はブルネイであり、使用言語はベンガル語(<code>Bangla</code>または<code>Bengali language</code>)、使用文字はベンガル文字(<code>Bangla lipi</code>または<code>Bengali alphabet</code>または<code>Bengali script</code>)と呼ばれることを知る</li>
</ul></li>
<li>ベンガル文字のどの文字が落ちる原因となるのかを詳しく調べるために<code>ওয়েব ব্রাউজার</code>を1文字または2文字ずつ別のファイルに分けて出力し、1ファイルずつ開く
<ul>
<li>クラッシュしない</li>
</ul></li>
<li><code>M-x view-hello-file</code>で<code>HELLO</code>ファイルを開く
<ul>
<li>ベンガル語のあいさつ<code>নমস্কার</code>ではクラッシュしない</li>
<li><code>C-u C-x =</code>を実行し、ベンガル文字にはNotoフォントを使っていることを確認する
<ul>
<li><code>script</code>セクションの出力からcharsetは<code>bengali</code>であることを知る</li>
</ul></li>
</ul></li>
<li><code>fc-list :lang=bn</code>でベンガル文字を含むフォントを探す
<ul>
<li>Notoフォント以外にはFreeSansとFreeSerifがインストールされていることを確認する</li>
</ul></li>
<li><a href="https://www.shimmy1996.com/en/posts/2018-06-24-fun-with-fonts-in-emacs/">Fun With Fonts in Emacs</a>を元にしたフォント設定の書式で、ベンガル語にはFreeSansを使う設定をする</li>
<li><a href="#tldr">tl;dr</a>の設定で<a href="https://github.com/MinhasKamal/BengaliDictionary/blob/master/BengaliDictionary_17.txt">ベンガル語の辞書ファイル</a>や<code>chromium.desktop</code>を開き、クラッシュしなくなることを確認する</li>
</ol>
<p>ちなみに、切っ掛けであったFirefoxのデフォルト化については以下の設定で実現できました。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cat ~/.local/share/applications/firefox.desktop</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="ex">[Desktop</span> Entry]</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="va">Version</span><span class="op">=</span>1.0</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="va">Name</span><span class="op">=</span>Firefox <span class="ex">Web</span> Browser</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="va">GenericName</span><span class="op">=</span>Web <span class="ex">Browser</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a><span class="va">Comment</span><span class="op">=</span>Access <span class="ex">the</span> Internet</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a><span class="va">Exec</span><span class="op">=</span>firefox <span class="ex">%U</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a><span class="va">Terminal</span><span class="op">=</span>false</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a><span class="ex">X-MultipleArgs=false</span></span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a><span class="va">Type</span><span class="op">=</span>Application</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a><span class="va">Icon</span><span class="op">=</span>firefox</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a><span class="va">Categories</span><span class="op">=</span>Network<span class="kw">;</span><span class="ex">WebBrowser</span><span class="kw">;</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a><span class="va">StartupWMClass</span><span class="op">=</span>Firefox</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a><span class="va">StartupNotify</span><span class="op">=</span>true</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a><span class="va">MimeType</span><span class="op">=</span>x-scheme-handler/unknown<span class="kw">;</span><span class="ex">x-scheme-handler/about</span><span class="kw">;</span><span class="ex">text/html</span><span class="kw">;</span><span class="ex">text/xml</span><span class="kw">;</span><span class="ex">application/xhtml_xml</span><span class="kw">;</span><span class="ex">application/x-mimearchive</span><span class="kw">;</span><span class="ex">x-scheme-handler/http</span><span class="kw">;</span><span class="ex">x-scheme-handler/https</span><span class="kw">;</span></span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> xdg-settings set default-web-browser firefox.desktop</span></code></pre></div>
<h2 id="参考">参考</h2>
<p>libotfがEmacsのクラッシュにつながるケースは以前からあったようです。</p>
<ul>
<li><a href="https://www.shimmy1996.com/en/posts/2018-06-24-fun-with-fonts-in-emacs/">Fun With Fonts in Emacs</a></li>
<li><a href="https://github.com/emacs-mirror/emacs/blob/master/etc/PROBLEMS">emacs/etc/PROBLEMS (GitHub)</a></li>
<li><a href="https://bugs.launchpad.net/ubuntu/+source/emacs24/+bug/1735167">Bug #1735167 “emacs (emacs24-x) crashes reliably on certain utf-…” : Bugs : emacs24 package : Ubuntu</a></li>
</ul>
<p><a href="https://www.shimmy1996.com/en/posts/2018-06-24-fun-with-fonts-in-emacs/">Fun With Fonts in Emacs</a>には非常に助けられています。</p>

    </div>
    <div id="footer">
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </div>
  </body>
</html>
