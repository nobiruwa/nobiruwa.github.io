<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/hakyll-cssgarden/bronx.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">
    <title>My Hakyll Blog - EmacsでのRust開発(rust-analyzer)</title>
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">Nobiruwa's</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
      </div>
    </div>

    <div id="content">
      <h1>EmacsでのRust開発(rust-analyzer)</h1>

      <div class="info">
    Posted on December 26, 2021
    
        by nobiruwa
    
</div>

<h2 id="tldr">tl;dr</h2>
<p><a href="2021-04-03-emacs-as-rust-ide.html">2021年4月3日の記事</a>では<a href="https://github.com/rust-lang/rls">rls</a>を使いましたが、<a href="https://github.com/rust-analyzer/rust-analyzer">rust-analyzer</a>を使うように手順を変更しました。<code>rls</code>と<code>rust-analyzer</code>の両方が存在する環境では<code>rust-analyzer</code>が優先されるようで、<a href="#rust-analyzerのインストール">rust-analyzerのインストール</a>以外は<a href="2021-04-03-emacs-as-rust-ide.html">2021年4月3日の記事</a>の内容そのままです。</p>
<p><a href="https://github.com/rust-lang/rust-mode">rust-mode</a>, <a href="https://github.com/emacs-lsp/lsp-mode">lsp-mode</a>, <a href="https://github.com/kwrooijen/cargo.el">cargo.el</a>と<a href="https://github.com/rust-analyzer/rust-analyzer">rust-analyzer</a>を用いることで、十分に快適な環境を得ることができました。</p>
<h2 id="rust-mode-lsp-mode-cargo.el-rust-analyzer-の構築手順">rust-mode + lsp-mode + cargo.el + rust-analyzer の構築手順</h2>
<p>開発のモードとしてrust-modeとlsp-modeとcargo.elのcargo-minor-modeを用い、バックエンドには<code>rust-analyzer</code>を用います。</p>
<h3 id="rust-analyzerのインストール">rust-analyzerのインストール</h3>
<p><a href="https://rust-analyzer.github.io/manual.html#rust-analyzer-language-server-binary">公式の手順</a>に従って<code>rust-analyzer</code>をインストールします。</p>
<p><a href="https://rustup.rs/">rustup</a>を使って<code>rust-src</code>をインストールします。</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> rustup component add rust-src</span></code></pre></div>
<p>次に<code>rust-analyzer</code>をインストールします。</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> mkdir <span class="at">-p</span> ~/.local/bin</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> curl <span class="at">-L</span> https://github.com/rust-analyzer/rust-analyzer/releases/latest/download/rust-analyzer-x86_64-unknown-linux-gnu.gz <span class="kw">|</span> <span class="fu">gunzip</span> <span class="at">-c</span> <span class="at">-</span> <span class="op">&gt;</span> ~/.local/bin/rust-analyzer</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> chmod +x ~/.local/bin/rust-analyzer</span></code></pre></div>
<h3 id="emacsパッケージのインストール">Emacsパッケージのインストール</h3>
<pre class="emacs"><code>M-x package-install
cargo
lsp-mode
lsp-ui
rust-mode</code></pre>
<h3 id="emacsパッケージの設定">Emacsパッケージの設定</h3>
<p><a href="2019-04-07-emacs-as-cpp-ide.html">過去の記事</a>でのlsp-mode, lsp-uiに加えて、lsp-mode, cargo-minor-mode, rust-modeのそれぞれに設定を行います。</p>
<h4 id="lsp-mode">lsp-mode</h4>
<div class="sourceCode" id="cb4"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; lsp-mode</span></span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>[...snip...]</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="co">;; rust</span></span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> lsp-rust-analyzer-proc-macro-enable <span class="kw">t</span>)</span></code></pre></div>
<h4 id="cargo-minor-mode">cargo-minor-mode</h4>
<div class="sourceCode" id="cb5"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; cargo-minor-mode</span></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'rust-mode)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>(add-hook 'rust-mode-hook 'cargo-minor-mode)</span></code></pre></div>
<h4 id="rust-mode">rust-mode</h4>
<div class="sourceCode" id="cb6"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; rust-mode</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> 'rust-mode)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>(add-hook 'rust-mode-hook</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">lambda</span> ()</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>            (<span class="kw">setq</span> indent-tabs-mode <span class="kw">nil</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>            (lsp)))</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a><span class="co">;; Formatting is bound to C-c C-f.</span></span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a><span class="co">;; The folowing enables automatic formatting on save.</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> rust-format-on-save <span class="kw">t</span>)</span></code></pre></div>
<h2 id="cargo-edit-cargo-featureのインストール">cargo-edit, cargo-featureのインストール</h2>
<p><a href="https://github.com/killercup/cargo-edit">cargo-edit</a>は<code>cargo add/rm/upgrade/set-version</code>サブコマンドを追加します。また、<a href="https://github.com/Riey/cargo-feature">cargo-feature</a>は<code>cargo feature</code>サブコマンドを追加します。</p>
<p><code>cargo add</code>と<code>cargo feature</code>を使うと、<code>Cargo.toml</code>の<code>[dependencies]</code>セクションと<code>[dev-dependencies]</code>セクションを記述するかわりに、コマンドラインから編集できるようになります。私には合っていると思い導入することにします。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cargo install cargo-edit</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="ex">$</span> cargo install cargo-feature</span></code></pre></div>
<p>ちなみに、サブコマンドの実体は<code>~/.cargo/bin</code>ディレクトリにあります。<code>cargo-add</code>, <code>cargo-feature</code>といったようにサブコマンドごとの実行ファイルが追加されます。</p>

    </div>
    <div id="footer">
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </div>
  </body>
</html>
