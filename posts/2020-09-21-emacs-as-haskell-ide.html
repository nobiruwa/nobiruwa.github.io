<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/hakyll-cssgarden/bronx.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">
    <title>My Hakyll Blog - EmacsでのHaskell開発(旧その2)</title>
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">Nobiruwa's</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
      </div>
    </div>

    <div id="content">
      <h1>EmacsでのHaskell開発(旧その2)</h1>

      <div class="info">
    Posted on September 21, 2020
    
        by nobiruwa
    
</div>

<h2 id="tldr">tl;dr</h2>
<p>本記事は2022年3月時点ではobsoleteとなりました。<a href="./2022-03-05-emacs-as-haskell-ide.html">新しい記事</a>を参照してください。</p>
<p><a href="https://github.com/emacs-lsp/lsp-haskell">lsp-haskell</a>のバックエンドとして<a href="https://github.com/haskell/haskell-language-server">haskell-language-server</a>を使うようにセットアップしました。</p>
<h3 id="切っ掛け">切っ掛け</h3>
<p><a href="https://github.com/haskell/haskell-ide-engine">haskell-ide-engine</a>を使っていましたが、haskell-ide-engineと<a href="https://github.com/haskell/ghcide/">ghcide</a>は統合されhaskell-language-serverによって置き換えられました。2020年9月21日時点のlsp-haskellはバックエンドがhaskell-language-serverに切り替わっていました。</p>
<h2 id="lsp-haskell-haskell-language-server-の構築手順">lsp-haskell + haskell-language-server の構築手順</h2>
<h3 id="haskell-language-server">haskell-language-server</h3>
<p>haskell-language-serverの<a href="https://github.com/haskell/haskell-language-server#installation">Installation</a>に従ってバイナリをインストールします。</p>
<h4 id="prerequistes">Prerequistes</h4>
<pre class="console"><code>$ sudo apt-get install libicu-dev libncurses-dev libgmp-dev zlib1g-dev</code></pre>
<h4 id="haskell-language-serverのビルド">haskell-language-serverのビルド</h4>
<pre class="console"><code>$ cd ~/repo
$ git clone https://github.com/haskell/haskell-language-server --recurse-submodules haskell-language-server.git
$ cd haskell-language-server.git</code></pre>
<pre class="console"><code>$ stack ./install.hs help

Usage:
    stack install.hs &lt;target&gt; [options]
    or
    cabal v2-run install.hs --project-file install/shake.project -- &lt;target&gt; [options]

Targets:
    help                Show help message including all targets
                        
    hls                 Install haskell-language-server with the latest available GHC and the data files
    latest              Install haskell-language-server with the latest available GHC
    data                Get the required data-files for `haskell-language-server` (Hoogle DB)
    hls-8.10.1          Install haskell-language-server for GHC version 8.10.1
    hls-8.10.2          Install haskell-language-server for GHC version 8.10.2
    hls-8.6.4           Install haskell-language-server for GHC version 8.6.4
    hls-8.6.5           Install haskell-language-server for GHC version 8.6.5
    hls-8.8.2           Install haskell-language-server for GHC version 8.8.2
    hls-8.8.3           Install haskell-language-server for GHC version 8.8.3
    hls-8.8.4           Install haskell-language-server for GHC version 8.8.4
                        
    dev                 Install haskell-language-server with the default stack.yaml
                        
    icu-macos-fix       Fixes icu related problems in MacOS

Options:
    -s, --silent        Don't print anything.
    -q, --quiet         Print less (pass repeatedly for even less).
    -V, --verbose       Print more (pass repeatedly for even more).

Build completed in 0.07s</code></pre>
<p>まずは最新のGHCバージョン(現時点は GHC version 8.8.4 でした)のビルドを行います。</p>
<pre class="console"><code>$ stack ./install.hs hls
[...snip...]
Copied executables to /home/ein/.local/bin:
- haskell-language-server
- haskell-language-server-wrapper
# stack (for hls-8.8.4)
Build completed in 22m03s</code></pre>
<p>次に、私が主に使用しているGHCバージョン(現時点は GHC version 8.6.5 です)のビルドを行います。</p>
<pre class="console"><code>$ stack ./install.hs hls-8.6.5
[...snip...]
Copied executables to /home/ein/.local/bin:
- haskell-language-server
- haskell-language-server-wrapper
# stack (for hls-8.6.5)
Build completed in 20m46s</code></pre>
<p>非力なマシンでは<code>-j</code>オプションで並列実行数を制限してください。</p>
<pre class="console"><code>$ stack ./install.hs -j1 hls-8.6.5</code></pre>
<p>あらゆるプロジェクトでのビルドで並列実行数を制限する場合はstackのグローバルな設定ファイルにGHCオプションを記述します。<code>~/.stack/config.yaml</code>に以下の行を追加するとよいでしょう。</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">&quot;$locals&quot;</span><span class="kw">:</span><span class="at"> -j1</span></span></code></pre></div>
<p>プロジェクトに合ったバージョンの<code>haskell-language-server-*</code>が使われない場合、<code>haskell-language-server</code>を削除することを試してください。</p>
<h3 id="emacs">Emacs</h3>
<h4 id="emacsパッケージのインストール">Emacsパッケージのインストール</h4>
<pre class="emacs"><code>M-x package-install
lsp-haskell</code></pre>
<h4 id="emacsパッケージの設定">Emacsパッケージの設定</h4>
<div class="sourceCode" id="cb9"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; lsp-haskell</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> <span class="dt">'lsp-haskell</span>)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>(add-hook <span class="dt">'haskell-mode-hook</span> <span class="op">#'</span>lsp)</span></code></pre></div>
<h3 id="プロジェクトの作成">プロジェクトの作成</h3>
<pre class="console"><code>$ stack new --resolver=&lt;resolver name&gt; &lt;project-name&gt;
// example
$ stack new --resolver=lts-14.27 http-conduit-example</code></pre>
<p>haskell-language-serverがプロジェクトのセットアップに失敗する場合はプロジェクトの設定ファイルを作成してみます。
設定に関する詳細は<a href="https://github.com/haskell/haskell-language-server#project-configuration">haskell-language-serverのREADME</a>と<a href="https://github.com/mpickering/hie-bios/blob/master/README.md#stack">hie-biosのREADME</a>の通りですが、以下に最小の設定を示します。</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cradle</span><span class="kw">:</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">stack</span><span class="kw">:</span></span></code></pre></div>

    </div>
    <div id="footer">
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </div>
  </body>
</html>
