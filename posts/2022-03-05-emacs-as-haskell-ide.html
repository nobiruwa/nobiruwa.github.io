<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/hakyll-cssgarden/bronx.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">
    <title>My Hakyll Blog - EmacsでのHaskell開発</title>
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">Nobiruwa's</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
      </div>
    </div>

    <div id="content">
      <h1>EmacsでのHaskell開発</h1>

      <div class="info">
    Posted on March  5, 2022
    
        by nobiruwa
    
</div>

<h2 id="tldr">tl;dr</h2>
<p><a href="https://www.haskell.org/ghcup/">GHCup</a>でHaskellのtoolchainをインストールできるようになりました。</p>
<h2 id="ghcupのインストールとセットアップ">GHCupのインストールとセットアップ</h2>
<p>まずは<code>~/.ghcup</code>に<code>ghcup</code>コマンドとほかのtoolchainをインストールします。</p>
<p>以下の1コマンドで終わります。</p>
<pre class="console"><code>$ curl --proto '=https' --tlsv1.2 -sSf https://get-ghcup.haskell.org | sh</code></pre>
<p>インストールの途中にシステム要件が表示されるので、その通りにパッケージをインストールします。</p>
<pre class="console"><code>$ sudo apt install build-essential curl libffi-dev libffi6 libgmp-dev libgmp10 libncurses-dev libncurses5 libtinfo5</code></pre>
<p><code>~/.profile</code>にて、環境変数<code>PATH</code>を設定します。</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="va">GHCUP_HOME</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$HOME</span><span class="st">/.ghcup&quot;</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="va">GHCUP_BIN</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$GHCUP_HOME</span><span class="st">/bin&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> <span class="bu">[</span> <span class="ot">-d</span> <span class="st">&quot;</span><span class="va">$GHCUP_BIN</span><span class="st">&quot;</span> <span class="bu">]</span><span class="kw">;</span> <span class="cf">then</span></span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="bu">export</span> <span class="va">PATH</span><span class="op">=</span><span class="st">&quot;</span><span class="va">$GHCUP_BIN</span><span class="st">:</span><span class="va">$PATH</span><span class="st">&quot;</span></span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a><span class="cf">fi</span></span></code></pre></div>
<p>あらゆるプロジェクトでのビルドで並列実行数を制限する場合はstackのグローバルな設定ファイルにGHCオプションを記述します。<code>~/.stack/config.yaml</code>に以下の行を追加するとよいでしょう。</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ghc-options</span><span class="kw">:</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">&quot;$locals&quot;</span><span class="kw">:</span><span class="at"> -j1</span></span></code></pre></div>
<h3 id="emacs">Emacs</h3>
<h4 id="emacsパッケージのインストール">Emacsパッケージのインストール</h4>
<pre class="emacs"><code>M-x package-install
lsp-haskell</code></pre>
<h4 id="emacsパッケージの設定">Emacsパッケージの設定</h4>
<p>rust-modeを真似てバッファー全体にフォーマットを掛けてから保存されるようにしています。</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode lisp"><code class="sourceCode commonlisp"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co">;; lsp-haskell</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co">;;;;;;;;</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>(<span class="kw">require</span> <span class="dt">'lsp-haskell</span>)</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>(<span class="kw">setq</span> lsp-haskell-formatting-provider <span class="st">&quot;brittany&quot;</span>)</span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a><span class="co">;; rust-modeを参考にバッファーを保存する時にフォーマットする</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>(defcustom haskell-format-on-save <span class="kw">nil</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Format future haskell buffers before saving using lsp-haskell-formatting-provider.&quot;</span></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="bu">:type</span> <span class="dt">'boolean</span></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  :safe <span class="op">#'</span>booleanp</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  :group <span class="dt">'lsp-haskell-mode</span>)</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> haskell-enable-format-on-save </span>()</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Enable formatting using lsp-haskell-formatting-provider when saving buffer.&quot;</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  (interactive)</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>  (setq-local haskell-format-on-save <span class="kw">t</span>))</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> haskell-disable-format-on-save </span>()</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Disable formatting using lsp-haskell-formatting-provider when saving buffer.&quot;</span></span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>  (interactive)</span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  (setq-local haskell-format-on-save <span class="kw">nil</span>))</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>(<span class="kw">defun</span><span class="fu"> haskell-format-save-hook </span>()</span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  <span class="st">&quot;Enable formatting using lsp-haskell-formatting-provider when saving buffer.&quot;</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>  (<span class="kw">when</span> haskell-format-on-save</span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>      (lsp-format-buffer)))</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a><span class="co">;; lsp-format-buffer, lsp-format-regionが使用するインデント幅を</span></span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a><span class="co">;; haskell-modeのhaskell-indentation-layout-offsetに合わせる</span></span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>(add-to-list <span class="dt">'lsp--formatting-indent-alist</span> '(haskell-mode . haskell-indentation-layout-offset))</span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>(add-hook <span class="dt">'before-save-hook</span> <span class="op">#'</span>haskell-format-save-hook)</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a>(add-hook <span class="dt">'haskell-mode-hook</span></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a>          (<span class="kw">lambda</span> ()</span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a>            (setq-local haskell-format-on-save <span class="kw">t</span>)</span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a>            (lsp)))</span></code></pre></div>
<h3 id="プロジェクトの作成">プロジェクトの作成</h3>
<pre class="console"><code>$ stack new --resolver=&lt;resolver name&gt; &lt;project-name&gt;
// example
$ stack new --resolver=lts-18.27 http-conduit-example</code></pre>
<p>haskell-language-serverがプロジェクトのセットアップに失敗する場合はプロジェクトの設定ファイルを作成してみます。
設定に関する詳細は<a href="https://github.com/haskell/haskell-language-server#project-configuration">haskell-language-serverのREADME</a>と<a href="https://github.com/mpickering/hie-bios/blob/master/README.md#stack">hie-biosのREADME</a>の通りですが、以下に最小の設定を示します。</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode yaml"><code class="sourceCode yaml"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cradle</span><span class="kw">:</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a><span class="at">  </span><span class="fu">stack</span><span class="kw">:</span></span></code></pre></div>

    </div>
    <div id="footer">
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </div>
  </body>
</html>
