<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="../css/hakyll-cssgarden/bronx.css">
    <link rel="stylesheet" href="../css/syntax.css">
    <link rel="stylesheet" href="../css/custom.css">
    <title>My Hakyll Blog - Debianのunstable版でtesting版のパッケージを使用する(Pinning)</title>
  </head>
  <body>
    <div id="header">
      <div id="logo">
        <a href="../">Nobiruwa's</a>
      </div>
      <div id="navigation">
        <a href="../">Home</a>
        <a href="../archive.html">Archive</a>
      </div>
    </div>

    <div id="content">
      <h1>Debianのunstable版でtesting版のパッケージを使用する(Pinning)</h1>

      <div class="info">
    Posted on February 12, 2022
    
        by nobiruwa
    
</div>

<h2 id="切っ掛け">切っ掛け</h2>
<p>Debianのunstable版を使っていると、<code>apt upgrade</code>を行ったタイミングでXが使えなくなることがあります。</p>
<p>少なくとも私のPCでは、<a href="https://wiki.debian.org/NvidiaGraphicsDrivers#Build_failures">NvidiaGraphicsDrivers#Build_failures - Debian Wiki</a>にあるようにNVIDIAのドライバが新しいカーネルに対応していない場合に起こっています。</p>
<p>この記事では回避方法として以下の3つが上げられています。</p>
<blockquote>
<p>Solutions for this, from most to least recommended, are temporarily
using an older kernel until the driver is updated, installing a
newer version of the driver from Debian Experimental if one is
available that supports your kernel version, or finding a patch for
the build failure online that can be added to DKMS.</p>
</blockquote>
<ol type="1">
<li>ドライバーが更新されるまでより古いカーネルを使う</li>
<li>experimental版のより新しいドライバーをインストールする</li>
<li>オンラインでDKMSに追加できるパッチを探す</li>
</ol>
<p>今回は、ドライバーが更新されるまでの暫定的な対応として、testing版から古いカーネルとドライバなど他のパッケージをpinning(ピン留め)を使ってインストールすることにしました。</p>
<h2 id="症状">症状</h2>
<p>以下のように<code>xserver-xorg-video-nvidia</code>の依存パッケージである<code>xorg-video-abi-NN</code>(<code>NN</code>はバージョン番号)を解決できずに失敗します。
<code>xorg-video-abi-NN</code>はvirtual packageであり、実際には適切なバージョンの<code>xserver-xorg-core</code>がないということを示しています。</p>
<pre class="console"><code>The following packages have unmet dependencies:
 xserver-xorg-video-nvidia : Depends: xorg-video-abi-24 or
                                      xorg-video-abi-23 but it is not installable or
                                      xorg-video-abi-20 but it is not installable or
                                      xorg-video-abi-19 but it is not installable or
                                      xorg-video-abi-18 but it is not installable or
                                      xorg-video-abi-15 but it is not installable or
                                      xorg-video-abi-14 but it is not installable or
                                      xorg-video-abi-13 but it is not installable or
                                      xorg-video-abi-12 but it is not installable or
                                      xorg-video-abi-11 but it is not installable or
                                      xorg-video-abi-10 but it is not installable or
                                      xorg-video-abi-8 but it is not installable or
                                      xorg-video-abi-6.0 but it is not installable
                             Depends: xserver-xorg-core (&lt; 2:1.20.99) but 2:21.1.3-2 is to be installed
E: Unable to correct problems, you have held broken packages.</code></pre>
<h2 id="sources.listの設定"><code>sources.list</code>の設定</h2>
<p>まずは<code>/etc/apt/sources.list</code>testing版のリポジトリを追加します。</p>
<pre><code>[...snip...]
deb http://ftp.jp.debian.org/debian/ testing main contrib non-free
[...snip...]</code></pre>
<p>パッケージを更新します。</p>
<pre class="console"><code>$ sudo apt update</code></pre>
<h2 id="apt_preferencesの設定"><code>apt_preferences</code>の設定</h2>
<p>次に、<a href="https://www.debian.org/doc/manuals/apt-howto/ch-apt-get.en.html#s-pin">3.10 How to keep specific versions of packages installed (complex) - APT HOWTO (Obsolete Documentation)</a>の説明を参考にしつつ、<code>/etc/apt/preferences.d/testing.pref</code>を作り以下の内容を記述しました。</p>
<pre><code># downgrade dependencies
Package: *
Pin: release a=testing
Pin-Priority: 50

# downgrade packages (Pin-Priority must be more than 1000.)
Package: linux-image-* linux-headers-* nvidia-driver nvidia-driver-bin xserver-xorg-video-nvidia nvidia-vdpau-driver nvidia-alternative nvidia-kernel-dkms nvidia-legacy-check nvidia-driver-libs nvidia-driver-libs-nonglvnd xserver-xorg-core xserver-xorg-input-*
Pin: release a=testing
Pin-Priority: 1001</code></pre>
<h3 id="個目のpinningの内容">1個目のPinningの内容</h3>
<p>testingアーカイブのパッケージをまず<code>Pin-Priotrity: 50</code>、つまり明示しない限りインストールの対象とならないようにします。</p>
<p>他のパッケージの依存関係として必要な場合もインストールされます。</p>
<h3 id="個目のpinningの内容-1">2個目のPinningの内容</h3>
<p>ダウングレードを可能とするために、<code>Pin-Priority</code>を<code>1001</code>にしています。</p>
<p>testingアーカイブからpinningするパッケージを<code>Packages</code>セクションに列挙します。</p>
<p>以下の設定が必要でした。</p>
<ol type="1">
<li>カーネルのダウングレードに必要だった設定
<ul>
<li><code>linux-image-* linux-headers-*</code></li>
</ul></li>
<li>ドライバのダウングレードに必要だった設定
<ul>
<li><code>nvidia-driver nvidia-driver-bin xserver-xorg-video-nvidia nvidia-vdpau-driver nvidia-alternative nvidia-kernel-dkms nvidia-legacy-check nvidia-driver-libs nvidia-driver-libs-nonglvnd xserver-xorg-core</code>
<ul>
<li><code>nvidia-driver</code>から<code>nvidia-driver-libs-nonglvnd</code>までは<a href="https://gist.github.com/Kreyren/cccf642ce672fd8f127ed128cf27749b#file-gistfile1-md">How to properly setup and install nvidia on Debian/Devuan - @Kreyren’s GitHub Gist</a>からそのまま拝借しました。</li>
<li>testing版とunstble版の<code>nvidia-driver</code>などNVIDIAのドライバに関係するパッケージのバージョンは同一だったので、pinningが真に必要なパッケージは<code>xserver-xorg-core</code>だけなのかもしれませんが、一応すべてpinningすることにしました。</li>
</ul></li>
</ul></li>
<li>マウスとキーボードを使用可能にするために必要だった設定
<ul>
<li><code>xserver-xorg-input-*</code>
<ul>
<li><code>startx</code>後にマウスがキーボードを使えなくなったため、<a href="https://stackoverflow.com/a/59127797/10974912">user interface - Mouse and Keyboard not working after reinstalling ubuntu-desktop - Stack Overflow</a>を参考に追加しました。</li>
</ul></li>
</ul></li>
</ol>
<h3 id="pinningの確認">Pinningの確認</h3>
<p><code>/etc/apt/preferences.d/testing.pref</code>の設定が<code>apt-cache policy</code>に反映されているかを確認します。</p>
<pre class="console"><code>$ sudo apt-cache policy
Package files:
[...snip...]
  50 http://ftp.jp.debian.org/debian testing/non-free i386 Packages
     release o=Debian,a=testing,n=bookworm,l=Debian,c=non-free,b=i386
     origin ftp.jp.debian.org
  50 http://ftp.jp.debian.org/debian testing/non-free amd64 Packages
     release o=Debian,a=testing,n=bookworm,l=Debian,c=non-free,b=amd64
     origin ftp.jp.debian.org
  50 http://ftp.jp.debian.org/debian testing/contrib i386 Packages
     release o=Debian,a=testing,n=bookworm,l=Debian,c=contrib,b=i386
     origin ftp.jp.debian.org
  50 http://ftp.jp.debian.org/debian testing/contrib amd64 Packages
     release o=Debian,a=testing,n=bookworm,l=Debian,c=contrib,b=amd64
     origin ftp.jp.debian.org
  50 http://ftp.jp.debian.org/debian testing/main i386 Packages
     release o=Debian,a=testing,n=bookworm,l=Debian,c=main,b=i386
     origin ftp.jp.debian.org
  50 http://ftp.jp.debian.org/debian testing/main amd64 Packages
     release o=Debian,a=testing,n=bookworm,l=Debian,c=main,b=amd64
     origin ftp.jp.debian.org
[...snip...]
Pinned packages:
     xserver-xorg-input-evdev -&gt; 1:2.10.6-2 with priority 1001
     xserver-xorg-input-mouse -&gt; 1:1.9.3-1 with priority 1001
     nvidia-alternative -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-core -&gt; 2:1.20.14-1 with priority 1001
     xserver-xorg-input-all -&gt; 1:7.7+23 with priority 1001
     xserver-xorg-input-kbd -&gt; 1:1.9.0-1+b2 with priority 1001
     xserver-xorg-input-mutouch -&gt; 1:1.3.0-2+b1 with priority 1001
     xserver-xorg-input-joystick -&gt; 1:1.6.3-1+b1 with priority 1001
     xserver-xorg-input-xwiimote -&gt; 0.5-1+b3 with priority 1001
     xserver-xorg-input-elographics -&gt; 1:1.4.2-1 with priority 1001
     nvidia-driver-bin -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-input-aiptek -&gt; 1:1.4.1-3+b1 with priority 1001
     nvidia-driver-libs -&gt; 470.103.01-1 with priority 1001
     nvidia-driver -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-input-synaptics -&gt; 1.9.1-2 with priority 1001
     nvidia-kernel-dkms -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-input-mtrack -&gt; 0.3.1-1+b3 with priority 1001
     xserver-xorg-input-libinput -&gt; 1.2.0-1 with priority 1001
     xserver-xorg-input-evdev-dev -&gt; 1:2.10.6-2 with priority 1001
     nvidia-legacy-check -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-input-wacom -&gt; 0.34.99.1-1+b1 with priority 1001
     xserver-xorg-input-joystick-dev -&gt; 1:1.6.3-1 with priority 1001
     nvidia-vdpau-driver -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-input-libinput-dev -&gt; 1.2.0-1 with priority 1001
     xserver-xorg-input-synaptics-dev -&gt; 1.9.1-2 with priority 1001
     xserver-xorg-video-nvidia -&gt; 470.103.01-1 with priority 1001
     xserver-xorg-input-multitouch -&gt; 1.0~rc3-2+b1 with priority 1001</code></pre>
<p>期待通りに反映されていることが確認できました。</p>
<h2 id="パッケージのダウングレードインストール">パッケージのダウングレードインストール</h2>
<p>最後にダウングレードインストールを行って完了です。</p>
<p>以下のステップによりXが再び使えるようになりました。</p>
<ol type="1">
<li>testing版のカーネルとヘッダーをインストール</li>
<li>testing版のドライバーをインストール</li>
<li>マウスとキーボードが使えなくなるので再インストール</li>
<li><code>/etc/X11/xorg.conf</code>を念の為更新</li>
</ol>
<p>実際のコマンドは以下の通りです。</p>
<pre class="console"><code>$ sudo apt install linux-{image,headers}-5.15.0-3-amd64 linux-kbuild-5.15
$ sudo apt install nvidia-driver/testing xserver-xorg-core/testing
$ sudo apt install xserver-xorg-input-all
$ sudo nvidia-xconfig</code></pre>
<p>他にもステップの途中で<code>autoremove</code>を求められるパッケージで削除されては困るものをインストールしました。</p>
<pre class="console"><code>$ sudo apt install xdg-dbus-proxy libwayland-client0</code></pre>
<p><code>startx</code>で動作テストに成功した後、Xが使えないカーネルは削除しました。</p>
<h2 id="unstable版のパッケージに戻してよいかのチェック">unstable版のパッケージに戻してよいかのチェック</h2>
<p>unstable版のパッケージに戻してよいかは、以下の<code>apt -s install</code>コマンドで確認できます。</p>
<pre class="console"><code>$ sudo apt update
$ sudo apt -s install xserver-xorg-core/unstable nvidia-driver/unstable xserver-xorg-video-nvidia/unstable</code></pre>
<p>新しいカーネルに戻す場合は、<code>linux-image-&lt;version&gt;-&lt;ARCH&gt;</code>と<code>linux-headers-&lt;version&gt;-&lt;ARCH&gt;</code>だけでなく<code>linux-kbuild-&lt;version&gt;</code>パッケージもインストールするようにしてください。</p>
<h2 id="参考">参考</h2>
<ul>
<li><a href="https://wiki.debian.org/NvidiaGraphicsDrivers#Build_failures">NvidiaGraphicsDrivers#Build_failures - Debian Wiki</a>
<ul>
<li>原因と回避方法が端的に記載されています。</li>
</ul></li>
<li><a href="https://www.debian.org/doc/manuals/apt-howto/ch-apt-get.en.html#s-pin">3.10 How to keep specific versions of packages installed (complex) - APT HOWTO (Obsolete Documentation)</a>
<ul>
<li>pinningの書式が分かりやすく書かれています。</li>
</ul></li>
<li><a href="https://gist.github.com/Kreyren/cccf642ce672fd8f127ed128cf27749b#file-gistfile1-md">How to properly setup and install nvidia on Debian/Devuan - @Kreyren’s GitHub Gist</a>
<ul>
<li>pinningの対象とすべきパッケージが記載されており参考にしました。</li>
</ul></li>
<li><a href="https://stackoverflow.com/a/59127797/10974912">user interface - Mouse and Keyboard not working after reinstalling ubuntu-desktop - Stack Overflow</a>
<ul>
<li>NVIDIAのドライバを再インストールをする時にキーボードとマウスが動かなくなる事象にいつもハマっています。
この質問と回答のおかげで<code>xserver-xorg-input-all</code>も再インストールが必要であることに気付かされました。</li>
</ul></li>
</ul>

    </div>
    <div id="footer">
      Site proudly generated by
      <a href="http://jaspervdj.be/hakyll">Hakyll</a>
    </div>
  </body>
</html>
